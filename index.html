<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
    <title>Stories</title>

    <link rel="stylesheet" href="http://localhost:3000/index.css" />
</head>

<body>
<div class="root">
    <div class="stop-screen" onclick="togglePlay()">
        <div class="stop-screen__plate"></div>
        <svg class="stop-screen__button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
                d="M11.0748 7.50835C9.74622 6.72395 8.25 7.79065 8.25 9.21316V14.7868C8.25 16.2093 9.74622 17.276 11.0748 16.4916L15.795 13.7048C17.0683 12.953 17.0683 11.047 15.795 10.2952L11.0748 7.50835ZM9.75 9.21316C9.75 9.01468 9.84615 8.87585 9.95947 8.80498C10.0691 8.73641 10.1919 8.72898 10.3122 8.80003L15.0324 11.5869C15.165 11.6652 15.25 11.8148 15.25 12C15.25 12.1852 15.165 12.3348 15.0324 12.4131L10.3122 15.2C10.1919 15.271 10.0691 15.2636 9.95947 15.195C9.84615 15.1242 9.75 14.9853 9.75 14.7868V9.21316Z" />
            <path
                d="M12 1.25C6.06294 1.25 1.25 6.06294 1.25 12C1.25 17.9371 6.06294 22.75 12 22.75C17.9371 22.75 22.75 17.9371 22.75 12C22.75 6.06294 17.9371 1.25 12 1.25ZM2.75 12C2.75 6.89137 6.89137 2.75 12 2.75C17.1086 2.75 21.25 6.89137 21.25 12C21.25 17.1086 17.1086 21.25 12 21.25C6.89137 21.25 2.75 17.1086 2.75 12Z" />
        </svg>
    </div>
    <div class="progress">
        <!-- script inserted progress-bars -->
    </div>
    <div class="stories" onclick="togglePlay()">
        <!-- script inserted stories -->
    </div>
    <button class="show-reactions-btn">üëç</button>
    <div class="controls">
        <div class="controls__buttons">
            <button onclick="prev()" class="button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L9.83 12l5.58-5.59z" />
                </svg>
            </button>
            <button onclick="next()" class="button button_next">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L9.83 12l5.58-5.59z" />
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    const videosSrc = [
        'http://localhost:3000/assets/1.mp4',
        'http://localhost:3000/assets/2.mp4',
        'http://localhost:3000/assets/3.mp4',
        'http://localhost:3000/assets/4.mp4',
        'http://localhost:3000/assets/5.mp4',
    ];

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentSlide = 0;
    let isPlaying = false;
    let isReactionsOpen = false;
    let videos = [];
    let progressBars = [];
    let slider;
    let progressContainer;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    function initializeElements() {
        slider = document.querySelector('.stories');
        progressContainer = document.querySelector('.progress');
        // –û—á–∏—Å—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        slider.innerHTML = '';
        progressContainer.innerHTML = '';
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–ª–∞–π–¥–æ–≤
    function createAllStories() {
        videosSrc.forEach((src, index) => {
            const story = initStory(index, src);
            videos.push(story.video);
            progressBars.push(story.progressBar);
        });
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤–∏–¥–µ–æ
    function setupVideoEvents(video, index) {
        video.addEventListener('loadedmetadata', () => {
            // –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∫–ª–∏–∫–Ω—É—Ç—å
            if (index === 0) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                document.querySelector('.stop-screen').classList.remove('stop-screen_playing');
            }
        });



        video.addEventListener('timeupdate', () => {
            updateProgress(index);
        });

        video.addEventListener('ended', () => {
            if (currentSlide < videos.length - 1) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–ª–∞–π–¥—É
                setTimeout(() => {
                    next();
                }, 100);
            } else {
                // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–ª–∞–π–¥ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è
                isPlaying = false;
                document.querySelector('.stop-screen').classList.remove('stop-screen_playing');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        video.addEventListener('error', (e) => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', video.src, e);
            if (currentSlide < videos.length - 1) {
                next();
            }
        });


    }

    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
    function preloadVideos() {
        videos.forEach(video => {
            video.preload = 'metadata';
        });
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
    function togglePlay() {
        if (isReactionsOpen) return;

        const currentVideo = videos[currentSlide];

        if (isPlaying) {
            currentVideo.pause();
            isPlaying = false;
            document.querySelector('.stop-screen').classList.remove('stop-screen_playing');
        } else {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            currentVideo.play().then(() => {
                isPlaying = true;
                document.querySelector('.stop-screen').classList.add('stop-screen_playing');
            }).catch((error) => {
                console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –±—Ä–∞—É–∑–µ—Ä–æ–º. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∫–ª–∏–∫–Ω—É—Ç—å –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è.');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                document.querySelector('.stop-screen').classList.remove('stop-screen_playing');
            });
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    function updateProgress(slideIndex) {
        if (slideIndex !== currentSlide) return;

        const video = videos[slideIndex];
        const progressBar = progressBars[slideIndex];

        if (video.duration && video.currentTime >= 0) {
            const progress = video.currentTime / video.duration;
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥—ã –≤–∫–ª—é—á–µ–Ω—ã –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            progressBar.classList.remove('no-transition');
            progressBar.style.transform = `scaleX(${progress})`;
        }
    }

    // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
    function resetProgressBars() {
        // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        progressBars.forEach(bar => {
            bar.classList.add('no-transition');
        });

        progressBars.forEach((bar, index) => {
            if (index < currentSlide) {
                // –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Å–ª–∞–π–¥—ã - –≤—Å–µ–≥–¥–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã (100%)
                bar.style.transform = 'scaleX(1)';
            } else if (index > currentSlide) {
                // –ë—É–¥—É—â–∏–µ —Å–ª–∞–π–¥—ã - –≤—Å–µ–≥–¥–∞ –ø—É—Å—Ç—ã–µ (0%)
                bar.style.transform = 'scaleX(0)';
            } else {
                // –¢–µ–∫—É—â–∏–π —Å–ª–∞–π–¥ - –Ω–∞—á–∏–Ω–∞–µ–º —Å 0%
                bar.style.transform = 'scaleX(0)';
            }
        });

        // –í–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã –æ–±—Ä–∞—Ç–Ω–æ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        setTimeout(() => {
            progressBars.forEach(bar => {
                bar.classList.remove('no-transition');
            });
        }, 50);
    }



                // –ü–æ–∫–∞–∑ —Å–ª–∞–π–¥–∞ (–ø–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ)
    function showSlide(slideIndex) {
        const stories = document.querySelectorAll('.stories__story');

        // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–ª–∞–π–¥—ã
        stories.forEach((story, index) => {
            if (index !== slideIndex) {
                story.classList.add('hidden');
                story.style.opacity = '0';
            }
        });

        // –ó–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Å–ª–∞–π–¥
        const targetStory = stories[slideIndex];
        if (targetStory) {
            targetStory.classList.remove('hidden');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–∞–π–¥ —Å—Ä–∞–∑—É
            targetStory.style.opacity = '1';
        }
    }

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–ª–∞–π–¥–æ–≤ (–ø–ª–∞–≤–Ω–æ–µ –∫–∞–∫ –≤ Instagram/Telegram)
    function switchSlide(newSlide) {
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ
        videos[currentSlide].pause();

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
        currentSlide = newSlide;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —Å–ª–∞–π–¥
        showSlide(currentSlide);

        // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        resetProgressBars();

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –≤–∏–¥–µ–æ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
        videos[currentSlide].currentTime = 0;

        // –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ
        if (isPlaying) {
            videos[currentSlide].play().then(() => {
                document.querySelector('.stop-screen').classList.add('stop-screen_playing');
            }).catch((error) => {
                console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å–ª–∞–π–¥–æ–≤.');
                isPlaying = false;
                document.querySelector('.stop-screen').classList.remove('stop-screen_playing');
            });
        } else {
            // –ï—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            document.querySelector('.stop-screen').classList.remove('stop-screen_playing');
        }
    }

        // –°–ª–µ–¥—É—é—â–∏–π —Å–ª–∞–π–¥
    function next() {
        if (currentSlide < videos.length - 1) {
            switchSlide(currentSlide + 1);
        }
    }

    // –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–∞–π–¥
    function prev() {
        if (currentSlide > 0) {
            switchSlide(currentSlide - 1);
        }
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ —Ä–µ–∞–∫—Ü–∏–π
    function showReactions() {
        if (isReactionsOpen) return;

        isReactionsOpen = true;
        isPlaying = false;
        videos[currentSlide].pause();

        // –°–æ–∑–¥–∞–Ω–∏–µ –æ–≤–µ—Ä–ª–µ—è
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.onclick = hideReactions;

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —Ä–µ–∞–∫—Ü–∏–π
        const reactions = document.createElement('div');
        reactions.className = 'reactions';
        reactions.innerHTML = `
            <button class="reaction" onclick="addReaction('üëç')">üëç</button>
            <button class="reaction" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
            <button class="reaction" onclick="addReaction('üòä')">üòä</button>
            <button class="reaction" onclick="addReaction('üéâ')">üéâ</button>
            <button class="reaction" onclick="addReaction('üî•')">üî•</button>
        `;

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—Å–ø–ª—ã—Ç–∏—è —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–∞–Ω–µ–ª–∏ —Ä–µ–∞–∫—Ü–∏–π
        reactions.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        document.querySelector('.root').appendChild(overlay);
        document.querySelector('.root').appendChild(reactions);
    }

    // –°–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ —Ä–µ–∞–∫—Ü–∏–π
    function hideReactions() {
        if (!isReactionsOpen) return;

        isReactionsOpen = false;

        // –£–¥–∞–ª–µ–Ω–∏–µ –æ–≤–µ—Ä–ª–µ—è –∏ —Ä–µ–∞–∫—Ü–∏–π
        const overlay = document.querySelector('.overlay');
        const reactions = document.querySelector('.reactions');

        if (overlay) overlay.remove();
        if (reactions) reactions.remove();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–∞—É–∑—ã (—Ç–∞–∫ –∫–∞–∫ –≤–∏–¥–µ–æ –±—ã–ª–æ –Ω–∞ –ø–∞—É–∑–µ)
        document.querySelector('.stop-screen').classList.remove('stop-screen_playing');
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–∏
    function addReaction(emoji) {
        // –°–æ–∑–¥–∞–Ω–∏–µ –ª–µ—Ç—è—â–µ–π —Ä–µ–∞–∫—Ü–∏–∏
        const flyingReaction = document.createElement('div');
        flyingReaction.className = 'flying-reaction';
        flyingReaction.textContent = emoji;
        flyingReaction.style.left = Math.random() * 80 + 10 + '%';

        document.querySelector('.root').appendChild(flyingReaction);

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
            flyingReaction.remove();
        }, 500);

        // –°–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ —Ä–µ–∞–∫—Ü–∏–π
        hideReactions();
    }

    // Touch —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
    function setupTouchEvents() {
        let startX = 0;
        let startY = 0;

        document.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', (e) => {
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const diffX = startX - endX;
            const diffY = startY - endY;

            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    next();
                } else {
                    prev();
                }
            }
        });
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏—Å—Ç–æ—Ä–∏–∏
    function getStory(id) {
        return {
            video: document.getElementById(`video-${id}`),
            progressBar: document.getElementById(`progress-${id}`)
        };
    }

            // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    function init() {
        initializeElements();
        createAllStories();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–µ–æ
        videos.forEach((video, index) => {
            setupVideoEvents(video, index);
        });

        preloadVideos();
        setupTouchEvents();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–ª–∞–π–¥–æ–≤
        const stories = document.querySelectorAll('.stories__story');
        stories.forEach((story, index) => {
            if (index === 0) {
                story.classList.remove('hidden');
                story.style.opacity = '1';
            } else {
                story.classList.add('hidden');
                story.style.opacity = '0';
            }
        });

        showSlide(0);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.querySelector('.stop-screen').classList.remove('stop-screen_playing');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏
    function initStory(id, src) {
        slider.insertAdjacentHTML(
            'beforeend',
            `<div class="stories__story">
                <video id="video-${id}" class="stories__video" src="${src}" preload="metadata" playsinline>
                    <p>–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.</p>
                </video>
            </div>`,
        );

        progressContainer.insertAdjacentHTML(
            'beforeend',
            `<span class="progress__bar">
                <span id="progress-${id}" class="progress__bar-value"></span>
            </span>`,
        );

        return getStory(id);
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', init);

    // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ —Ä–µ–∞–∫—Ü–∏–π
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.show-reactions-btn').addEventListener('click', showReactions);
    });
</script>
</body>

</html>